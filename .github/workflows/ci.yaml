name: ci

on:
  push:
    branches: ["main"]
  pull_request:

permissions:
  contents: read
  id-token: write

env:
  NODE_VERSION: '20'

jobs:
  lint_test:
    name: Build and test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set git sha
        run: echo "GIT_SHA=${GITHUB_SHA}" >> $GITHUB_ENV
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Lint
        run: npm run lint
      - name: Run unit tests
        run: npm test -- --ci
      - name: Dependency audit
        run: npm audit --audit-level=high
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage

  docker_scan:
    name: Build & scan image
    runs-on: ubuntu-latest
    needs: lint_test
    steps:
      - uses: actions/checkout@v4
      - name: Prepare metadata
        id: prep
        run: |
          IMAGE="ghcr.io/${{ github.repository }}:${{ github.sha }}"
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT
          echo "GIT_SHA=${GITHUB_SHA}" >> $GITHUB_ENV
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build image
        run: docker build --build-arg GIT_SHA=${GIT_SHA} -t ${{ steps.prep.outputs.image }} .
      - name: Trivy scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ steps.prep.outputs.image }}
          format: 'table'
          exit-code: '1'
          vuln-type: 'os,library'
          severity: 'HIGH,CRITICAL'
      - name: Export SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ steps.prep.outputs.image }}
          format: spdx-json
          output-file: sbom.spdx.json
      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.spdx.json

  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    needs: docker_scan
    if: github.ref == 'refs/heads/main' && vars.EKS_CLUSTER_NAME != ''
    env:
      AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
      EKS_CLUSTER_NAME: ${{ vars.EKS_CLUSTER_NAME }}
      TODO_SERVICE_ACCOUNT_ROLE_ARN: ${{ secrets.TODO_SERVICE_ACCOUNT_ROLE_ARN }}
    steps:
      - uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name "$EKS_CLUSTER_NAME" --region "$AWS_REGION"
      - name: Render manifests
        env:
          GIT_SHA: ${{ github.sha }}
        run: |
          mkdir -p rendered
          for file in k8s/*.yaml; do
            envsubst < "$file" > "rendered/$(basename "$file")"
          done
      - name: Apply manifests
        run: kubectl apply -f rendered/
      - name: Verify rollout
        run: kubectl rollout status deployment/todo-api -n app --timeout=120s
